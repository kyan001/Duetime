{% extends "base.html" %}
{% block title %}卡片笔记 - 详情{% endblock %}

{% block css %}
    <style>
        .inner-container {
            padding-top: 15px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="inner-container">
        <div class="row">
            <div class="col-xs-12 col-sm-6 col-sm-offset-3">
                <form id="update-form" action="/cardnote/update" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="id" value="{{ card.id }}">
                    <input type="hidden" name="newitems" value="">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <span>
                                <div class="input-group">
                                    <span class="input-group-addon">
                                        《
                                    </span>
                                    <input class="form-control" type="text" name="title" value="{{ card.title }}" placeholder="{{ card.title }}">
                                    <span class="input-group-addon">
                                        》
                                    </span>
                                </div>
                            </span>
                        </div>

                        <div class="panel-body">
                        <table class="table table-striped table-bordered table-hover">
                            <tr>
                                <th class="text-center">
                                    列名
                                </th>
                                <th>
                                    <input class="form-control" type="text" name="kcol" value="{{ card.kcol }}" placeholder="{{ card.kcol|default:'选填' }}">
                                </th>
                                <th>
                                    <input class="form-control" type="text" name="vcol" value="{{ card.vcol }}" placeholder="{{ card.vcol|default:'选填' }}">
                                </th>
                                <th class="text-center">
                                    操作
                                </th>
                            </tr>
                            {% for old_item in card.cardnoteitems %}
                                <tr class="item-row">
                                    <td class="text-center">
                                        #{{ forloop.counter }}
                                    </td>
                                    <td>
                                        <input class="form-control" type="text" data-name="kword" value="{{ old_item.kword }}" placeholder="{{ old_item.kword }}">
                                    </td>
                                    <td>
                                        <input class="form-control" type="text" data-name="val" value="{{ old_item.val }}" placeholder="{{ old_item.val }}">
                                    </td>
                                    <td>
                                        <a class="btn btn-danger" role="button" onclick="removeItemRow(this)">
                                            <span class="glyphicon glyphicon-remove"></span>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            <tr id="new-row-btn-tr">
                                <td colspan="3">
                                </td>
                                <td colspan="1">
                                    <a class="btn btn-default btn-block" onclick="addItemRow()">
                                        <span class="glyphicon glyphicon-plus"></span>
                                    </a>
                                </td>
                            </tr>
                        </table>
                            <div class="small">
                                <span class="text-muted">
                                    <span class="glyphicon glyphicon-play"></span>
                                    <span>{{ card.created|date:"Y-m-d H:i" }}</span>
                                </span>
                                <span class="text-muted pull-right">
                                    <span class="glyphicon glyphicon-pause"></span>
                                    <span>{{ card.modified|date:"Y-m-d H:i" }}</span>
                                </span>
                            </div>
                        </div>
                        <div class="panel-footer">
                            <div class="btn-group btn-group-justified">
                                <a class="btn btn-default" href="/cardnote/list">取消</a>
                                <a class="btn btn-success" role="button" onclick="submitForm()">保存</a>
                            </div>
                        </div>
                    </div><!--.panel-->
                </form>
            </div><!--.col-->
        </div><!--.row-->
    </div><!--.inner-container-->
</div>
{% endblock content %}

{% block js %}
    <script>
        $(function(){
        })
        function submitForm(){
            var title = $("input[name='title']").val()
            if(!title){
                $.danger("卡片名称不能为空")
                return false
            }
            var item_dicts = []
            $('.item-row').each(function(){
                var kword = $(this).find('input[data-name="kword"]').val()
                var val = $(this).find('input[data-name="val"]').val()
                if (!kword && !val){
                    $(this).remove()
                } else {
                    var item_dict = {
                        'kword': kword,
                        'val': val,
                    }
                    item_dicts.push(item_dict)
                }
            })
            $('input[name="newitems"]').val(JSON.stringify(item_dicts))
            $("#update-form").submit()
        }
        function addItemRow(){
            var tr = $("<tr class='item-row'></tr>")
            var kword_input = $("<input class='form-control' type='text' data-name='kword' placeholder='（选填）'>")
            var val_input = $("<input class='form-control' type='text' data-name='val' placeholder='（选填）'>")
            var remove_btn = $("<a class='btn btn-danger' role='button' onclick='removeItemRow(this)'></a>").append("<span class='glyphicon glyphicon-remove'></span>")
            var tds = [
                $("<td></td>").addClass("text-center").text("New"),
                $("<td></td>").append(kword_input),
                $("<td></td>").append(val_input),
                $("<td></td>").append(remove_btn),
            ]
            for(i in tds){
                tr.append(tds[i])
            }
            tr.insertBefore($("#new-row-btn-tr"))
            kword_input.focus()
        }
        function removeItemRow(ele){
            $(ele).parents('.item-row').remove()
        }
    </script>
{% endblock %}
